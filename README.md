# Chromecast Tools

Some experimental tools that are meant to run on a rooted Chromecast in order to provision and sign device certificates.

This is a stripped down version of the code that can be found in [Chromecast-widevine-tools](https://github.com/EiNSTeiN-/Chromecast-widevine-tools). This fork retains the code that is necessary to interact with `libGtvCa`, the library that allows us to provision and sign device certificates on a Chromecast.

## Disclaimer

This code may brick your Chromecast. **Use at your own risk.**

## Usage

This repo provides headers for private, otherwise undocumented APIs exposed by libraries on the Chromecast. Using these headers, tools can be built to interact with these libraries.

**bin/gtv-ca-sign**

This tool will print a valid signature for a given SHA1 hash. The signature is produced using the private key corresponding to the provided keystore, or `/factory/client.key.bin` by default.

This signature is required if someone wanted to interact with the Google Chrome extension by impersonating a Chromecast, for instance using [Leapcast](https://github.com/EiNSTeiN-/leapcast) or [GoCast](https://github.com/tristanpenman/go-cast).

**tools/make-cert.py**

The Python script `tools/make-cert.py` will generate a self-signed certificate and private key, and print out the `gtv_ca_sign` command that you need to run (on a Chromecast) to get a valid signature for that self-signed certificate.

This script requires [pyOpenSSL](https://pypi.org/project/pyOpenSSL/). To install pyOpenSSL, and any other requirements, you can run:

    pip3 install -r requirements.txt

It is recommended that you set up a virtual Python environment for this, using `pyenv` for example.

**tools/cert-miner.sh**

Finally, to make this convenient for larger scale certificate generation, an additional `cert-miner.sh` script has been included. This script will automatically connect to a device using ADB, upload the `gtv-ca-sign` binary, and repeatedly run `make-cert.py` to generate peer certificates. Each peer certificate will be signed using the device private key, and the output written to a Certificate Manifest.

## Device Authentication

This signature is validated by the [Google Cast Chrome Extension](https://chrome.google.com/webstore/detail/google-cast/boadgeojelhgndaghljhdicfkmllpafd) (i.e. the one that runs in your browser) when the extension connects to the Chromecast.

You can find an implementation of the [signature verification code here](https://chromium.googlesource.com/chromium/chromium/+/HEAD/chrome/browser/extensions/api/cast_channel/cast_auth_util_nss.cc). Below we'll try to explain in detail the device authentication performed by the chrome extension.

When the extension connects to a Chromecast, the connection is protected by TLS, using a self-signed certificate and corresponding private key (such as the one generated by `make-cert.py`). As part of the cast_v2 protocol, the extension sends a device auth request, to which the device replies with a DER-encoded copy of its "client certificate" and a valid signature.

The client certificate for a Chromecast is stored in `/factory/client.crt` on the Chromecast itself, unfortunately the private key is encrypted, hence why we need to run `gtv_ca_sign` on the Chromecast itself. The Chrome extension's trust anchor is a "ICA Certificate" whose public key hardcoded in the cast_v2 protocol implementation (linked in the above paragraph).

For a successful device authentication to be performed, the extension will first check that the device's "client certificate" was signed by the "ICA Certificate". Then it checks that the signature provided in the device auth response is a valid signature over the DER-encoded form of the self-signed certificate.

## Build

Before you can use `bin/gtv-ca-sign` you'll need to compile it from source. This can be done on most typical x86-64 Linux systems, if you have the base development tools packages.

You'll also need to extract the Chromecast toolchain in the [toolchain](./toolchain) directory. After extracting [toolchain/arm-unknown-linux-gnueabi-4.5.3-glibc.tar.xz](./toolchain/arm-unknown-linux-gnueabi-4.5.3-glibc.tar.xz) you should have a directory called `toolchain/arm-unknown-linux-gnueabi-4.5.3-glibc`.

Then you can run `make` to compile `bin/gta-ca-sign`.

Alternatively, you can use a Docker image, as described below.

## Dockerfile

A Dockerfile has been included for building on platforms other than Linux.

You can build the Docker image like so:

    docker build . -t Chromecast-tools

You can then run `bash` inside a container based on the `Chromecast-tools` image:

    docker run -v `pwd`:/workspace --rm -it Chromecast-tools /bin/bash

From there, you can run `make`, to build `bin/gtv-ca-sign`. This is the binary that you will want to run on your rooted Chromecast.

## Getting Root Access

In order to use any of this code, you will need access to a rooted Chromecast. These have become very difficult to obtain, as the rooting process only works with early Chromecasts (e.g. first-gen) that have not been updated with a boot-loader that prevents rooting.

Some links that may find useful in this journey:
- https://www.techowns.com/root-Chromecast/
- https://Chromecastappstips.com/how-to-root-Chromecast/
- https://www.youtube.com/watch?v=A7BedB1AQls
